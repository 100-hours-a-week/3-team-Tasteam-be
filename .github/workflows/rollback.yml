name: Backend Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë¡¤ë°±í•  í™˜ê²½'
        required: true
        type: choice
        options:
          - develop
          - main
      run_number:
        description: 'ë¡¤ë°±í•  Run Number'
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment == 'main' && 'production' || 'development' }}
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      # 1. GitHub CLIë¥¼ ì´ìš©í•´ run_numberì— í•´ë‹¹í•˜ëŠ” ì‹¤ì œ run-idë¥¼ ì°¾ìŠµë‹ˆë‹¤.
      - name: Find Run ID
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ì§€ì •í•œ ë¸Œëœì¹˜ì™€ run_numberì— ë§ëŠ” run-id ì°¾ê¸°
          RUN_ID=$(gh run list \
            --workflow "Backend CI/CD - Full Pipeline" \
            --json databaseId,number,headBranch \
            --jq ".[] | select(.number == ${{ inputs.run_number }} and .headBranch == \"${{ inputs.environment }}\") | .databaseId" \
            | head -n 1)

          if [ -z "$RUN_ID" ]; then
            echo "âŒ Error: ${{ inputs.environment }} ë¸Œëœì¹˜ì˜ Run Number ${{ inputs.run_number }}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo ""
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ ìµœê·¼ ë¹Œë“œ ëª©ë¡:"
            gh run list --workflow "Backend CI/CD - Full Pipeline" --branch "${{ inputs.environment }}" --limit 10
            exit 1
          fi

          echo "FOUND_RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "âœ… ì°¾ì€ Run ID: $RUN_ID (Run Number: ${{ inputs.run_number }}, Branch: ${{ inputs.environment }})"

      # 2. ì°¾ì€ Run IDë¥¼ ì‚¬ìš©í•˜ì—¬ ì•„í‹°íŒ©íŠ¸ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar-${{ inputs.environment }}-${{ inputs.run_number }}
          run-id: ${{ env.FOUND_RUN_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ./rollback-temp

      # 3. ë‹¤ìš´ë¡œë“œí•œ JAR íŒŒì¼ í™•ì¸
      - name: Show JAR Info
        run: |
          echo "=== Rollback JAR Info ==="
          ls -lh ./rollback-temp/
          echo ""
          JAR_FILE=$(ls ./rollback-temp/*.jar | head -1)
          if [ -f "$JAR_FILE" ]; then
            echo "ë¡¤ë°±í•  JAR íŒŒì¼: $(basename $JAR_FILE)"
          else
            echo "âŒ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

      # 4. ì„œë²„ë¡œ JAR íŒŒì¼ ì „ì†¡
      - name: Transfer JAR to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "./rollback-temp/*.jar"
          target: "/home/${{ secrets.USERNAME }}/backend/temp"
          strip_components: 1

      # 5. ë¬´ì¤‘ë‹¨ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ë¡¤ë°±)
      - name: Execute Blue-Green Deployment (Rollback)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # JAR íŒŒì¼ëª… ì¶”ì¶œ ë° ê²½ë¡œ ì„¤ì •
            JAR_NAME=$(ls -t /home/${{ secrets.USERNAME }}/backend/temp/*.jar | head -1)
            DEPLOY_SCRIPT="/home/${{ secrets.USERNAME }}/deploy/deploy.sh"

            # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            chmod +x $DEPLOY_SCRIPT

            # ë¬´ì¤‘ë‹¨ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ í˜¸ì¶œ (ë¡¤ë°± JARë¡œ)
            echo "ğŸ”„ ë¡¤ë°± ì‹œì‘: Run Number ${{ inputs.run_number }}"
            $DEPLOY_SCRIPT $JAR_NAME

      # 6. ë¡¤ë°± ê²°ê³¼ ì•Œë¦¼
      - name: Notify Rollback Result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            TITLE="ë°±ì—”ë“œ ${{ inputs.environment == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„ ë¡¤ë°± ì„±ê³µ âœ…"
            COLOR=65280
          else
            TITLE="ë°±ì—”ë“œ ${{ inputs.environment == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„ ë¡¤ë°± ì‹¤íŒ¨ âŒ"
            COLOR=16711680
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"embeds\": [{
                   \"title\": \"$TITLE\",
                   \"color\": $COLOR,
                   \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
                   \"fields\": [
                     {\"name\": \"ê²°ê³¼\", \"value\": \"${{ job.status }}\", \"inline\": true},
                     {\"name\": \"í™˜ê²½\", \"value\": \"${{ inputs.environment == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }}\", \"inline\": true},
                     {\"name\": \"ì‹¤í–‰ì\", \"value\": \"${{ github.actor }}\", \"inline\": true},
                     {\"name\": \"ë¡¤ë°± ëŒ€ìƒ Run Number\", \"value\": \"${{ inputs.run_number }}\", \"inline\": false},
                     {\"name\": \"ì„œë²„ í™˜ê²½\", \"value\": \"${{ inputs.environment == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„\", \"inline\": false},
                     {\"name\": \"ì›Œí¬í”Œë¡œìš°\", \"value\": \"[ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": false}
                   ]
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
