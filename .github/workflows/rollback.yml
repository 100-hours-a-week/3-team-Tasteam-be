name: Backend Rollback (CodeDeploy)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë¡¤ë°±í•  í™˜ê²½(ë¸Œëœì¹˜ ê¸°ì¤€)'
        required: true
        type: choice
        options:
          - develop
          - main
      rollback_mode:
        description: 'ë¡¤ë°± ëŒ€ìƒ ì„ íƒ ë°©ì‹'
        required: true
        type: choice
        default: previous_successful
        options:
          - previous_successful
          - deployment_id
      target_deployment_id:
        description: 'rollback_mode=deployment_idì¼ ë•Œ ì§€ì • (ì˜ˆ: d-ABC123XYZ)'
        required: false
        type: string

permissions:
  id-token: write
  contents: read

concurrency:
  group: codedeploy-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment == 'main' && 'production' || 'development' }}
    timeout-minutes: 30

    env:
      AWS_REGION: ap-northeast-2
      DEFAULT_DEPLOYMENT_CONFIG_NAME: ${{ inputs.environment == 'main' && 'CodeDeployDefault.OneAtATime' || 'CodeDeployDefault.AllAtOnce' }}

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Resolve rollback target and trigger CodeDeploy
        id: rollback
        env:
          ROLLBACK_MODE: ${{ inputs.rollback_mode }}
          REQUESTED_DEPLOYMENT_ID: ${{ inputs.target_deployment_id }}
          CODEDEPLOY_APP_NAME: ${{ secrets.CODEDEPLOY_APP_NAME }}
          CODEDEPLOY_DEPLOYMENT_GROUP: ${{ secrets.CODEDEPLOY_DEPLOYMENT_GROUP }}
        run: |
          set -euo pipefail
          export AWS_PAGER=""

          fail() {
            echo "âŒ $*"
            exit 1
          }

          [ -n "${CODEDEPLOY_APP_NAME}" ] || fail "CODEDEPLOY_APP_NAME secret is required"
          [ -n "${CODEDEPLOY_DEPLOYMENT_GROUP}" ] || fail "CODEDEPLOY_DEPLOYMENT_GROUP secret is required"

          if [ "${ROLLBACK_MODE}" = "deployment_id" ]; then
            [ -n "${REQUESTED_DEPLOYMENT_ID}" ] || fail "rollback_mode=deployment_id ì¸ ê²½ìš° target_deployment_id ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤."
            SOURCE_DEPLOYMENT_ID="${REQUESTED_DEPLOYMENT_ID}"
          elif [ "${ROLLBACK_MODE}" = "previous_successful" ]; then
            mapfile -t SUCCEEDED_DEPLOYMENTS < <(
              aws deploy list-deployments \
                --application-name "${CODEDEPLOY_APP_NAME}" \
                --deployment-group-name "${CODEDEPLOY_DEPLOYMENT_GROUP}" \
                --include-only-statuses Succeeded \
                --max-items 20 \
                --query 'deployments' \
                --output text \
              | tr '\t' '\n' \
              | sed '/^$/d;/^None$/d'
            )

            [ "${#SUCCEEDED_DEPLOYMENTS[@]}" -gt 0 ] || fail "ì„±ê³µ ì´ë ¥ì´ ì—†ì–´ ìë™ ë¡¤ë°± ëŒ€ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

            LATEST_DEPLOYMENT_ID="$(aws deploy list-deployments \
              --application-name "${CODEDEPLOY_APP_NAME}" \
              --deployment-group-name "${CODEDEPLOY_DEPLOYMENT_GROUP}" \
              --max-items 1 \
              --query 'deployments[0]' \
              --output text || true)"

            LATEST_DEPLOYMENT_STATUS=""
            if [ -n "${LATEST_DEPLOYMENT_ID}" ] && [ "${LATEST_DEPLOYMENT_ID}" != "None" ]; then
              LATEST_DEPLOYMENT_STATUS="$(aws deploy get-deployment \
                --deployment-id "${LATEST_DEPLOYMENT_ID}" \
                --query 'deploymentInfo.status' \
                --output text)"
            fi

            if [ "${LATEST_DEPLOYMENT_STATUS}" = "Succeeded" ]; then
              [ "${#SUCCEEDED_DEPLOYMENTS[@]}" -ge 2 ] || fail "ì§ì „ ì„±ê³µ ë°°í¬ê°€ ì—†ì–´ ìë™ ë¡¤ë°±ì„ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. deployment_id ëª¨ë“œë¡œ ëŒ€ìƒ ë°°í¬ë¥¼ ì§ì ‘ ì§€ì •í•˜ì„¸ìš”."
              SOURCE_DEPLOYMENT_ID="${SUCCEEDED_DEPLOYMENTS[1]}"
            else
              SOURCE_DEPLOYMENT_ID="${SUCCEEDED_DEPLOYMENTS[0]}"
            fi
          else
            fail "ì§€ì›í•˜ì§€ ì•ŠëŠ” rollback_mode: ${ROLLBACK_MODE}"
          fi

          SOURCE_STATUS="$(aws deploy get-deployment \
            --deployment-id "${SOURCE_DEPLOYMENT_ID}" \
            --query 'deploymentInfo.status' \
            --output text)"
          [ "${SOURCE_STATUS}" = "Succeeded" ] || fail "ë¡¤ë°± ëŒ€ìƒ ë°°í¬(${SOURCE_DEPLOYMENT_ID}) ìƒíƒœê°€ Succeededê°€ ì•„ë‹™ë‹ˆë‹¤: ${SOURCE_STATUS}"

          SOURCE_APP="$(aws deploy get-deployment \
            --deployment-id "${SOURCE_DEPLOYMENT_ID}" \
            --query 'deploymentInfo.applicationName' \
            --output text)"
          SOURCE_GROUP="$(aws deploy get-deployment \
            --deployment-id "${SOURCE_DEPLOYMENT_ID}" \
            --query 'deploymentInfo.deploymentGroupName' \
            --output text)"

          [ "${SOURCE_APP}" = "${CODEDEPLOY_APP_NAME}" ] || fail "ë°°í¬ ëŒ€ìƒ Application ë¶ˆì¼ì¹˜: ${SOURCE_APP} (expected: ${CODEDEPLOY_APP_NAME})"
          [ "${SOURCE_GROUP}" = "${CODEDEPLOY_DEPLOYMENT_GROUP}" ] || fail "ë°°í¬ ëŒ€ìƒ Deployment Group ë¶ˆì¼ì¹˜: ${SOURCE_GROUP} (expected: ${CODEDEPLOY_DEPLOYMENT_GROUP})"

          REVISION_TYPE="$(aws deploy get-deployment \
            --deployment-id "${SOURCE_DEPLOYMENT_ID}" \
            --query 'deploymentInfo.revision.revisionType' \
            --output text)"
          [ "${REVISION_TYPE}" = "S3" ] || fail "í˜„ì¬ rollback workflowëŠ” S3 revisionë§Œ ì§€ì›í•©ë‹ˆë‹¤. actual=${REVISION_TYPE}"

          read -r REV_BUCKET REV_KEY REV_BUNDLE REV_ETAG REV_VERSION <<<"$(aws deploy get-deployment \
            --deployment-id "${SOURCE_DEPLOYMENT_ID}" \
            --query 'deploymentInfo.revision.s3Location.[bucket,key,bundleType,eTag,version]' \
            --output text)"

          [ -n "${REV_BUCKET}" ] && [ "${REV_BUCKET}" != "None" ] || fail "S3 bucket ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
          [ -n "${REV_KEY}" ] && [ "${REV_KEY}" != "None" ] || fail "S3 key ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
          [ -n "${REV_BUNDLE}" ] && [ "${REV_BUNDLE}" != "None" ] || fail "bundleType ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."

          DEPLOYMENT_CONFIG_NAME="$(aws deploy get-deployment \
            --deployment-id "${SOURCE_DEPLOYMENT_ID}" \
            --query 'deploymentInfo.deploymentConfigName' \
            --output text)"
          if [ -z "${DEPLOYMENT_CONFIG_NAME}" ] || [ "${DEPLOYMENT_CONFIG_NAME}" = "None" ]; then
            DEPLOYMENT_CONFIG_NAME="${DEFAULT_DEPLOYMENT_CONFIG_NAME}"
          fi

          S3_LOCATION="bucket=${REV_BUCKET},key=${REV_KEY},bundleType=${REV_BUNDLE}"
          if [ -n "${REV_ETAG:-}" ] && [ "${REV_ETAG}" != "None" ]; then
            S3_LOCATION="${S3_LOCATION},eTag=${REV_ETAG}"
          fi
          if [ -n "${REV_VERSION:-}" ] && [ "${REV_VERSION}" != "None" ]; then
            S3_LOCATION="${S3_LOCATION},version=${REV_VERSION}"
          fi

          ROLLBACK_DEPLOYMENT_ID="$(aws deploy create-deployment \
            --application-name "${CODEDEPLOY_APP_NAME}" \
            --deployment-group-name "${CODEDEPLOY_DEPLOYMENT_GROUP}" \
            --deployment-config-name "${DEPLOYMENT_CONFIG_NAME}" \
            --description "Rollback to ${SOURCE_DEPLOYMENT_ID} (workflow run ${GITHUB_RUN_ID})" \
            --s3-location "${S3_LOCATION}" \
            --query 'deploymentId' \
            --output text)"

          echo "source_deployment_id=${SOURCE_DEPLOYMENT_ID}" >> "$GITHUB_OUTPUT"
          echo "rollback_deployment_id=${ROLLBACK_DEPLOYMENT_ID}" >> "$GITHUB_OUTPUT"
          echo "rollback_deployment_config_name=${DEPLOYMENT_CONFIG_NAME}" >> "$GITHUB_OUTPUT"
          echo "rollback_revision_s3_key=${REV_KEY}" >> "$GITHUB_OUTPUT"

          {
            echo "### CodeDeploy Rollback Target"
            echo "- source deployment: \`${SOURCE_DEPLOYMENT_ID}\`"
            echo "- new rollback deployment: \`${ROLLBACK_DEPLOYMENT_ID}\`"
            echo "- deployment config: \`${DEPLOYMENT_CONFIG_NAME}\`"
            echo "- artifact: \`s3://${REV_BUCKET}/${REV_KEY}\`"
          } >> "$GITHUB_STEP_SUMMARY"

          echo "ğŸ”„ ë¡¤ë°± ì‹œì‘: source=${SOURCE_DEPLOYMENT_ID}, new=${ROLLBACK_DEPLOYMENT_ID}"

      - name: Wait rollback deployment result
        env:
          ROLLBACK_DEPLOYMENT_ID: ${{ steps.rollback.outputs.rollback_deployment_id }}
        run: |
          set -euo pipefail
          aws deploy wait deployment-successful --deployment-id "${ROLLBACK_DEPLOYMENT_ID}"
          aws deploy get-deployment --deployment-id "${ROLLBACK_DEPLOYMENT_ID}" --query 'deploymentInfo.status' --output text

      - name: Notify Rollback Result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            TITLE="ë°±ì—”ë“œ ${{ inputs.environment == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„ ë¡¤ë°± ì„±ê³µ âœ…"
            COLOR=65280
          else
            TITLE="ë°±ì—”ë“œ ${{ inputs.environment == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„ ë¡¤ë°± ì‹¤íŒ¨ âŒ"
            COLOR=16711680
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"embeds\": [{
                   \"title\": \"$TITLE\",
                   \"color\": $COLOR,
                   \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
                   \"fields\": [
                     {\"name\": \"ê²°ê³¼\", \"value\": \"${{ job.status }}\", \"inline\": true},
                     {\"name\": \"í™˜ê²½\", \"value\": \"${{ inputs.environment == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }}\", \"inline\": true},
                     {\"name\": \"ì‹¤í–‰ì\", \"value\": \"${{ github.actor }}\", \"inline\": true},
                     {\"name\": \"ë¡¤ë°± ëª¨ë“œ\", \"value\": \"${{ inputs.rollback_mode }}\", \"inline\": false},
                     {\"name\": \"ë¡¤ë°± ê¸°ì¤€ ë°°í¬ ID\", \"value\": \"${{ steps.rollback.outputs.source_deployment_id || inputs.target_deployment_id || 'ìë™ ì„ íƒ ì‹¤íŒ¨' }}\", \"inline\": false},
                     {\"name\": \"ìƒì„±ëœ ë¡¤ë°± ë°°í¬ ID\", \"value\": \"${{ steps.rollback.outputs.rollback_deployment_id || 'ìƒì„± ì‹¤íŒ¨' }}\", \"inline\": false},
                     {\"name\": \"ì„œë²„ í™˜ê²½\", \"value\": \"${{ inputs.environment == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„\", \"inline\": false},
                     {\"name\": \"ì›Œí¬í”Œë¡œìš°\", \"value\": \"[ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": false}
                   ]
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
