name: Backend CI/CD - Full Pipeline

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main

jobs:
  # PR 시에만 테스트 실행
  test:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      # 테스트 실행
      - name: Run Tests
        run: ./gradlew test

      # 테스트 실패 디스코드 알림
      - name: Notify Test Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "백엔드 테스트 실패 ❌",
                   "color": 16711680,
                   "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                   "fields": [
                     {"name": "결과", "value": "실패", "inline": true},
                     {"name": "브랜치", "value": "${{ github.ref_name }}", "inline": true},
                     {"name": "작성자", "value": "${{ github.actor }}", "inline": true},
                     {"name": "커밋", "value": "`${{ github.sha }}`", "inline": false},
                     {"name": "이벤트", "value": "PR 테스트", "inline": false},
                     {"name": "워크플로우", "value": "[실행 로그 보기](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                   ]
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

  # PR 시에만 보안 검사 실행
  security-scan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      # CodeQL 보안 분석 - 빌드 전에 초기화
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java
          queries: security-and-quality

      # 메인 코드 컴파일 (보안 분석용)
      - name: Compile Main Sources
        run: ./gradlew classes

      # CodeQL 분석 수행
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:java"

      # 보안 분석 - SpotBugs (메인 코드만 분석)
      - name: Run SpotBugs Security Analysis
        run: ./gradlew :app-api:spotbugsMain
        continue-on-error: true

      # SpotBugs 리포트 업로드
      - name: Upload SpotBugs Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-report-${{ github.sha }}
          path: app-api/build/reports/spotbugs/main/spotbugs.html
          retention-days: 7

      # 보안 스캔 실패 알림 (성공 시 알림 없음)
      - name: Notify Security Scan Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "백엔드 보안 스캔 실패 ❌",
                   "color": 16711680,
                   "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                   "fields": [
                     {"name": "결과", "value": "실패", "inline": true},
                     {"name": "브랜치", "value": "${{ github.ref_name }}", "inline": true},
                     {"name": "작성자", "value": "${{ github.actor }}", "inline": true},
                     {"name": "커밋", "value": "`${{ github.sha }}`", "inline": false},
                     {"name": "이벤트", "value": "PR 보안 검사", "inline": false},
                     {"name": "워크플로우", "value": "[실행 로그 보기](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                   ]
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

  # develop/main push 시에만 빌드 & 배포
  build-and-deploy:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      # 배포용 빌드 (JAR 생성, 테스트는 PR에서 이미 완료)
      - name: Build JAR for deployment
        run: ./gradlew build -x test

      # JAR 파일 업로드 (deploy job에서 사용, plain JAR 제외)
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar-${{ github.ref_name }}-${{ github.run_number }}
          path: app-api/build/libs/*[!plain].jar
          retention-days: 7

      # 빌드 실패 알림
      - name: Notify Build Failure
        if: failure()
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            ENV_NAME="운영"
          else
            ENV_NAME="개발"
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"embeds\": [{
                   \"title\": \"백엔드 ${ENV_NAME} 빌드 실패 ❌\",
                   \"color\": 16711680,
                   \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
                   \"fields\": [
                     {\"name\": \"결과\", \"value\": \"실패\", \"inline\": true},
                     {\"name\": \"브랜치\", \"value\": \"${{ github.ref_name }}\", \"inline\": true},
                     {\"name\": \"작성자\", \"value\": \"${{ github.actor }}\", \"inline\": true},
                     {\"name\": \"커밋\", \"value\": \"\`${{ github.sha }}\`\", \"inline\": false},
                     {\"name\": \"이벤트\", \"value\": \"${{ github.ref_name }} 브랜치 빌드\", \"inline\": false},
                     {\"name\": \"워크플로우\", \"value\": \"[실행 로그 보기](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": false}
                   ]
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

  deploy:
    needs: build-and-deploy
    if: github.event_name == 'push' && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}

    steps:
      # 빌드 산출물 다운로드
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar-${{ github.ref_name }}-${{ github.run_number }}
          path: ./deploy-temp

      # 서버로 JAR 전송
      - name: Transfer JAR to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "./deploy-temp/*.jar"
          target: "/home/${{ secrets.USERNAME }}/backend/temp"
          strip_components: 1

      # 무중단 배포 스크립트 실행
      - name: Execute Blue-Green Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # JAR 파일명 추출 및 경로 설정
            JAR_NAME=$(ls -t /home/${{ secrets.USERNAME }}/backend/temp/*.jar | head -1)
            DEPLOY_SCRIPT="/home/${{ secrets.USERNAME }}/deploy/deploy.sh"

            # 스크립트 실행 권한 부여
            chmod +x $DEPLOY_SCRIPT

            # 무중단 배포 스크립트 호출
            $DEPLOY_SCRIPT $JAR_NAME

      # 배포 결과 알림
      - name: Notify Deployment Result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            TITLE="백엔드 ${{ github.ref == 'refs/heads/main' && '운영' || '개발' }} 서버 배포 성공 ✅"
            COLOR=65280
          else
            TITLE="백엔드 ${{ github.ref == 'refs/heads/main' && '운영' || '개발' }} 서버 배포 실패 ❌"
            COLOR=16711680
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"embeds\": [{
                   \"title\": \"$TITLE\",
                   \"color\": $COLOR,
                   \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
                   \"fields\": [
                     {\"name\": \"결과\", \"value\": \"${{ job.status }}\", \"inline\": true},
                     {\"name\": \"브랜치\", \"value\": \"${{ github.ref_name }}\", \"inline\": true},
                     {\"name\": \"작성자\", \"value\": \"${{ github.actor }}\", \"inline\": true},
                     {\"name\": \"커밋\", \"value\": \"\`${{ github.sha }}\`\", \"inline\": false},
                     {\"name\": \"서버 환경\", \"value\": \"${{ github.ref == 'refs/heads/main' && '운영' || '개발' }} 서버\", \"inline\": false},
                     {\"name\": \"워크플로우\", \"value\": \"[실행 로그 보기](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": false}
                   ]
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
