name: Backend CI/CD - Full Pipeline

on:
  push:
    branches:
      - develop
      - main
    paths-ignore:
      - "**/*.md"
  pull_request:
    branches:
      - develop
      - main
    paths-ignore:
      - "**/*.md"

jobs:
  # PR ì‹œì—ë§Œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run Tests
        run: ./gradlew test

      # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ë””ìŠ¤ì½”ë“œ ì•Œë¦¼
      - name: Notify Test Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ âŒ",
                   "color": 16711680,
                   "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                   "fields": [
                     {"name": "ê²°ê³¼", "value": "ì‹¤íŒ¨", "inline": true},
                     {"name": "ë¸Œëœì¹˜", "value": "${{ github.ref_name }}", "inline": true},
                     {"name": "ì‘ì„±ì", "value": "${{ github.actor }}", "inline": true},
                     {"name": "ì»¤ë°‹", "value": "`${{ github.sha }}`", "inline": false},
                     {"name": "ì´ë²¤íŠ¸", "value": "PR í…ŒìŠ¤íŠ¸", "inline": false},
                     {"name": "ì›Œí¬í”Œë¡œìš°", "value": "[ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                   ]
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

  # PR ì‹œì—ë§Œ ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰
  security-scan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      # CodeQL ë³´ì•ˆ ë¶„ì„ - ë¹Œë“œ ì „ì— ì´ˆê¸°í™”
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java
          queries: security-and-quality

      # ë©”ì¸ ì½”ë“œ ì»´íŒŒì¼ (ë³´ì•ˆ ë¶„ì„ìš©)
      - name: Compile Main Sources
        run: ./gradlew classes

      # CodeQL ë¶„ì„ ìˆ˜í–‰
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:java"

      # ë³´ì•ˆ ë¶„ì„ - SpotBugs (ë©”ì¸ ì½”ë“œë§Œ ë¶„ì„)
      - name: Run SpotBugs Security Analysis
        run: ./gradlew :app-api:spotbugsMain
        continue-on-error: true

      # SpotBugs ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      - name: Upload SpotBugs Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-report-${{ github.sha }}
          path: app-api/build/reports/spotbugs/main/spotbugs.html
          retention-days: 7

      # ë³´ì•ˆ ìŠ¤ìº” ì‹¤íŒ¨ ì•Œë¦¼ (ì„±ê³µ ì‹œ ì•Œë¦¼ ì—†ìŒ)
      - name: Notify Security Scan Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "ë°±ì—”ë“œ ë³´ì•ˆ ìŠ¤ìº” ì‹¤íŒ¨ âŒ",
                   "color": 16711680,
                   "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                   "fields": [
                     {"name": "ê²°ê³¼", "value": "ì‹¤íŒ¨", "inline": true},
                     {"name": "ë¸Œëœì¹˜", "value": "${{ github.ref_name }}", "inline": true},
                     {"name": "ì‘ì„±ì", "value": "${{ github.actor }}", "inline": true},
                     {"name": "ì»¤ë°‹", "value": "`${{ github.sha }}`", "inline": false},
                     {"name": "ì´ë²¤íŠ¸", "value": "PR ë³´ì•ˆ ê²€ì‚¬", "inline": false},
                     {"name": "ì›Œí¬í”Œë¡œìš°", "value": "[ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                   ]
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

  # develop/main push ì‹œì—ë§Œ CodeDeploy ë°°í¬
  deploy:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
    timeout-minutes: 30
    permissions:
      id-token: write
      contents: read
    concurrency:
      group: codedeploy-${{ github.ref_name }}
      cancel-in-progress: false

    env:
      AWS_REGION: ap-northeast-2
      DEPLOY_DIR: deploy/codedeploy/backend
      ARTIFACT_FILE: codedeploy-backend-${{ github.sha }}.zip
      IMAGE_TAG_SHA: ${{ github.sha }}
      IMAGE_TAG_LATEST: latest
      DEPLOY_ENV_NAME: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
      DEPLOYMENT_CONFIG_NAME: ${{ github.ref == 'refs/heads/main' && 'CodeDeployDefault.OneAtATime' || 'CodeDeployDefault.AllAtOnce' }}
      GHA_CACHE_SCOPE: ${{ github.ref == 'refs/heads/main' && 'backend-codedeploy-prod' || 'backend-codedeploy-dev' }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend image (with GHA cache)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: app-api/Dockerfile
          push: true
          tags: |
            ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_BACKEND }}:${{ env.IMAGE_TAG_SHA }}
            ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_BACKEND }}:${{ env.IMAGE_TAG_LATEST }}
          cache-from: type=gha,scope=${{ env.GHA_CACHE_SCOPE }}
          cache-to: type=gha,mode=max,scope=${{ env.GHA_CACHE_SCOPE }}

      - name: Package CodeDeploy artifact
        env:
          ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
          ECR_REPO_BACKEND: ${{ secrets.ECR_REPOSITORY_BACKEND }}
        run: |
          set -euo pipefail
          cd "${DEPLOY_DIR}"
          [ -n "${ECR_REGISTRY}" ] && [ -n "${ECR_REPO_BACKEND}" ] || { echo "ECR_REGISTRY/ECR_REPO_BACKEND secret is required"; exit 1; }
          cat > .env.deploy <<EOF
          ENV_NAME=${DEPLOY_ENV_NAME}
          AWS_REGION=${AWS_REGION}
          ECR_REGISTRY=${ECR_REGISTRY}
          ECR_REPO_BACKEND=${ECR_REPO_BACKEND}
          IMAGE_TAG=${IMAGE_TAG_SHA}
          EOF

          chmod +x deploy.sh stop.sh health.sh traffic.sh switch.sh rollback.sh
          zip -r "${GITHUB_WORKSPACE}/${ARTIFACT_FILE}" \
            appspec.yml \
            deploy.sh \
            stop.sh \
            health.sh \
            traffic.sh \
            switch.sh \
            rollback.sh \
            docker-compose.backend.yml \
            docker-compose.dev-infra.yml \
            docker-compose.alloy.yml \
            alloy/ \
            .env.deploy \
            RUNBOOK.md

      - name: Upload artifact to S3
        env:
          CODEDEPLOY_BUCKET: ${{ secrets.CODEDEPLOY_ARTIFACT_BUCKET }}
        run: |
          set -euo pipefail
          aws s3 cp "${ARTIFACT_FILE}" "s3://${CODEDEPLOY_BUCKET}/backend/${ARTIFACT_FILE}"

      - name: Trigger CodeDeploy deployment
        id: trigger
        env:
          CODEDEPLOY_BUCKET: ${{ secrets.CODEDEPLOY_ARTIFACT_BUCKET }}
          CODEDEPLOY_APP_NAME: ${{ secrets.CODEDEPLOY_APP_NAME }}
          CODEDEPLOY_DEPLOYMENT_GROUP: ${{ secrets.CODEDEPLOY_DEPLOYMENT_GROUP }}
        run: |
          set -euo pipefail
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name "${CODEDEPLOY_APP_NAME}" \
            --deployment-group-name "${CODEDEPLOY_DEPLOYMENT_GROUP}" \
            --deployment-config-name "${DEPLOYMENT_CONFIG_NAME}" \
            --description "Deploy ${GITHUB_SHA}" \
            --s3-location bucket="${CODEDEPLOY_BUCKET}",key="backend/${ARTIFACT_FILE}",bundleType=zip \
            --query deploymentId \
            --output text)

          echo "deployment_id=${DEPLOYMENT_ID}" >> "$GITHUB_OUTPUT"
          echo "Triggered deployment: ${DEPLOYMENT_ID}"

      - name: Wait deployment result
        env:
          DEPLOYMENT_ID: ${{ steps.trigger.outputs.deployment_id }}
        run: |
          set -euo pipefail
          aws deploy wait deployment-successful --deployment-id "${DEPLOYMENT_ID}"
          aws deploy get-deployment --deployment-id "${DEPLOYMENT_ID}" --query 'deploymentInfo.status' --output text

      # ë°°í¬ ê²°ê³¼ ì•Œë¦¼
      - name: Notify Deployment Result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            TITLE="ë°±ì—”ë“œ ${{ github.ref == 'refs/heads/main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„ ë°°í¬ ì„±ê³µ â¤ï¸"
            COLOR=65280
          else
            TITLE="ë°±ì—”ë“œ ${{ github.ref == 'refs/heads/main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„ ë°°í¬ ì‹¤íŒ¨ ğŸ’”ğŸ’€"
            COLOR=16711680
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"embeds\": [{
                   \"title\": \"$TITLE\",
                   \"color\": $COLOR,
                   \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
                   \"fields\": [
                     {\"name\": \"ê²°ê³¼\", \"value\": \"${{ job.status }}\", \"inline\": true},
                     {\"name\": \"ë¸Œëœì¹˜\", \"value\": \"${{ github.ref_name }}\", \"inline\": true},
                     {\"name\": \"ì‘ì„±ì\", \"value\": \"${{ github.actor }}\", \"inline\": true},
                     {\"name\": \"ì»¤ë°‹\", \"value\": \"\`${{ github.sha }}\`\", \"inline\": false},
                     {\"name\": \"ì„œë²„ í™˜ê²½\", \"value\": \"${{ github.ref == 'refs/heads/main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„\", \"inline\": false},
                     {\"name\": \"ì›Œí¬í”Œë¡œìš°\", \"value\": \"[ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": false}
                   ]
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
