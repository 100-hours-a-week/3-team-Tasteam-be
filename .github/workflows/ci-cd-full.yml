name: Backend CI/CD - Full Pipeline

on:
  push:
    branches:
      - develop
      - main
    paths-ignore:
      - "**/*.md"
  pull_request:
    branches:
      - develop
      - main
    paths-ignore:
      - "**/*.md"

jobs:
  # PR ì‹œì—ë§Œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run Tests
        run: ./gradlew test

      # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ë””ìŠ¤ì½”ë“œ ì•Œë¦¼
      - name: Notify Test Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ âŒ",
                   "color": 16711680,
                   "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                   "fields": [
                     {"name": "ê²°ê³¼", "value": "ì‹¤íŒ¨", "inline": true},
                     {"name": "ë¸Œëœì¹˜", "value": "${{ github.ref_name }}", "inline": true},
                     {"name": "ì‘ì„±ì", "value": "${{ github.actor }}", "inline": true},
                     {"name": "ì»¤ë°‹", "value": "`${{ github.sha }}`", "inline": false},
                     {"name": "ì´ë²¤íŠ¸", "value": "PR í…ŒìŠ¤íŠ¸", "inline": false},
                     {"name": "ì›Œí¬í”Œë¡œìš°", "value": "[ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                   ]
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

  # PR ì‹œì—ë§Œ ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰
  security-scan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      # CodeQL ë³´ì•ˆ ë¶„ì„ - ë¹Œë“œ ì „ì— ì´ˆê¸°í™”
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java
          queries: security-and-quality

      # ë©”ì¸ ì½”ë“œ ì»´íŒŒì¼ (ë³´ì•ˆ ë¶„ì„ìš©)
      - name: Compile Main Sources
        run: ./gradlew classes

      # CodeQL ë¶„ì„ ìˆ˜í–‰
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:java"

      # ë³´ì•ˆ ë¶„ì„ - SpotBugs (ë©”ì¸ ì½”ë“œë§Œ ë¶„ì„)
      - name: Run SpotBugs Security Analysis
        run: ./gradlew :app-api:spotbugsMain
        continue-on-error: true

      # SpotBugs ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      - name: Upload SpotBugs Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-report-${{ github.sha }}
          path: app-api/build/reports/spotbugs/main/spotbugs.html
          retention-days: 7

      # ë³´ì•ˆ ìŠ¤ìº” ì‹¤íŒ¨ ì•Œë¦¼ (ì„±ê³µ ì‹œ ì•Œë¦¼ ì—†ìŒ)
      - name: Notify Security Scan Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d '{
                 "embeds": [{
                   "title": "ë°±ì—”ë“œ ë³´ì•ˆ ìŠ¤ìº” ì‹¤íŒ¨ âŒ",
                   "color": 16711680,
                   "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                   "fields": [
                     {"name": "ê²°ê³¼", "value": "ì‹¤íŒ¨", "inline": true},
                     {"name": "ë¸Œëœì¹˜", "value": "${{ github.ref_name }}", "inline": true},
                     {"name": "ì‘ì„±ì", "value": "${{ github.actor }}", "inline": true},
                     {"name": "ì»¤ë°‹", "value": "`${{ github.sha }}`", "inline": false},
                     {"name": "ì´ë²¤íŠ¸", "value": "PR ë³´ì•ˆ ê²€ì‚¬", "inline": false},
                     {"name": "ì›Œí¬í”Œë¡œìš°", "value": "[ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                   ]
                 }]
               }' \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

  # develop/main push ì‹œì—ë§Œ ë¹Œë“œ & ë°°í¬
  build-and-deploy:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      # ë°°í¬ìš© ë¹Œë“œ (JAR ìƒì„±, í…ŒìŠ¤íŠ¸ëŠ” PRì—ì„œ ì´ë¯¸ ì™„ë£Œ)
      - name: Build JAR for deployment
        run: ./gradlew build -x test

      # JAR íŒŒì¼ ì—…ë¡œë“œ (deploy jobì—ì„œ ì‚¬ìš©, plain JAR ì œì™¸)
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar-${{ github.ref_name }}-${{ github.run_number }}
          path: app-api/build/libs/*[!plain].jar
          retention-days: 7

      # ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼
      - name: Notify Build Failure
        if: failure()
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            ENV_NAME="ìš´ì˜"
          else
            ENV_NAME="ê°œë°œ"
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"embeds\": [{
                   \"title\": \"ë°±ì—”ë“œ ${ENV_NAME} ë¹Œë“œ ì‹¤íŒ¨ ğŸ’”ğŸ’€\",
                   \"color\": 16711680,
                   \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
                   \"fields\": [
                     {\"name\": \"ê²°ê³¼\", \"value\": \"ì‹¤íŒ¨\", \"inline\": true},
                     {\"name\": \"ë¸Œëœì¹˜\", \"value\": \"${{ github.ref_name }}\", \"inline\": true},
                     {\"name\": \"ì‘ì„±ì\", \"value\": \"${{ github.actor }}\", \"inline\": true},
                     {\"name\": \"ì»¤ë°‹\", \"value\": \"\`${{ github.sha }}\`\", \"inline\": false},
                     {\"name\": \"ì´ë²¤íŠ¸\", \"value\": \"${{ github.ref_name }} ë¸Œëœì¹˜ ë¹Œë“œ\", \"inline\": false},
                     {\"name\": \"ì›Œí¬í”Œë¡œìš°\", \"value\": \"[ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": false}
                   ]
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}

  deploy:
    needs: build-and-deploy
    if: github.event_name == 'push' && (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}

    steps:
      # ë¹Œë“œ ì‚°ì¶œë¬¼ ë‹¤ìš´ë¡œë“œ
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar-${{ github.ref_name }}-${{ github.run_number }}
          path: ./deploy-temp

      # ì„œë²„ë¡œ JAR ì „ì†¡
      - name: Transfer JAR to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "./deploy-temp/*.jar"
          target: "/home/${{ secrets.USERNAME }}/backend/temp"
          strip_components: 1

      # ë¬´ì¤‘ë‹¨ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Execute Blue-Green Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # JAR íŒŒì¼ëª… ì¶”ì¶œ ë° ê²½ë¡œ ì„¤ì •
            JAR_NAME=$(ls -t /home/${{ secrets.USERNAME }}/backend/temp/*.jar | head -1)
            DEPLOY_SCRIPT="/home/${{ secrets.USERNAME }}/deploy/deploy.sh"

            # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            chmod +x $DEPLOY_SCRIPT

            # ë¬´ì¤‘ë‹¨ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ í˜¸ì¶œ
            $DEPLOY_SCRIPT $JAR_NAME

      # ë°°í¬ ê²°ê³¼ ì•Œë¦¼
      - name: Notify Deployment Result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            TITLE="ë°±ì—”ë“œ ${{ github.ref == 'refs/heads/main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„ ë°°í¬ ì„±ê³µ â¤ï¸"
            COLOR=65280
          else
            TITLE="ë°±ì—”ë“œ ${{ github.ref == 'refs/heads/main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„ ë°°í¬ ì‹¤íŒ¨ ğŸ’”ğŸ’€"
            COLOR=16711680
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"embeds\": [{
                   \"title\": \"$TITLE\",
                   \"color\": $COLOR,
                   \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
                   \"fields\": [
                     {\"name\": \"ê²°ê³¼\", \"value\": \"${{ job.status }}\", \"inline\": true},
                     {\"name\": \"ë¸Œëœì¹˜\", \"value\": \"${{ github.ref_name }}\", \"inline\": true},
                     {\"name\": \"ì‘ì„±ì\", \"value\": \"${{ github.actor }}\", \"inline\": true},
                     {\"name\": \"ì»¤ë°‹\", \"value\": \"\`${{ github.sha }}\`\", \"inline\": false},
                     {\"name\": \"ì„œë²„ í™˜ê²½\", \"value\": \"${{ github.ref == 'refs/heads/main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„\", \"inline\": false},
                     {\"name\": \"ì›Œí¬í”Œë¡œìš°\", \"value\": \"[ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": false}
                   ]
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
