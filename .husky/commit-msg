#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

COMMIT_MESSAGE_FILE="$1"

if [ ! -s "$COMMIT_MESSAGE_FILE" ]; then
  exit 0
fi

first_line=$(sed -n '1p' "$COMMIT_MESSAGE_FILE")
remaining_lines=$(tail -n +2 "$COMMIT_MESSAGE_FILE")

# ê³µë™ ì»¤ë°‹ìž íŠ¸ë ˆì¼ëŸ¬ ì°¨ë‹¨
if echo "$first_line" | grep -Eiq '^[[:space:]]*co-authored-by:[[:space:]]*'; then
  echo "â›” ê³µë™ ì»¤ë°‹ìž(Co-authored-by) íŠ¸ë ˆì¼ëŸ¬ê°€ í¬í•¨ë˜ì–´ ìžˆì–´ ì»¤ë°‹ì„ ë§‰ì•˜ìŠµë‹ˆë‹¤."
  echo "   ê³µë™ ì»¤ë°‹ìžê°€ í•„ìš”í•œ ê²½ìš° íŒ€ ì •ì±…ì— ë”°ë¼ ìˆ˜ë™ ì²˜ë¦¬í•˜ì„¸ìš”."
  exit 1
fi

# ë¯¸ë¦¬ ì´ëª¨ì§€+íƒ€ìž…ì´ í¬í•¨ëœ ë©”ì‹œì§€ì´ë©´ ìƒëžµ
case "$first_line" in
  "âœ¨ feat"*)      exit 0 ;;
  "ðŸ› fix"*)       exit 0 ;;
  "âš¡ï¸ perf"*)      exit 0 ;;
  "â™»ï¸ refactor"*)  exit 0 ;;
  "âœ… test"*)      exit 0 ;;
  "ðŸ“ docs"*)      exit 0 ;;
  "ðŸ’„ style"*)     exit 0 ;;
  "ðŸ”§ chore"*)     exit 0 ;;
  "ðŸ” ci"*)        exit 0 ;;
  "ðŸ“¦ build"*)     exit 0 ;;
  "âª revert"*)    exit 0 ;;
esac

# Merge/Amend/Reset/Tag ë©”ì‹œì§€ëŠ” ìžì—°ìŠ¤ëŸ½ê²Œ í†µê³¼
case "$first_line" in
  Merge*|Revert*|Amend*|Reset*|Rebase*|Tag*)
    exit 0
    ;;
esac

type=$(echo "$first_line" | grep -o "^[A-Za-z]*")
normalized_type=$(echo "$type" | tr 'A-Z' 'a-z')

emoji=""
case "$normalized_type" in
  feat)     emoji="âœ¨" ;;
  fix)      emoji="ðŸ›" ;;
  perf)     emoji="âš¡ï¸" ;;
  refactor) emoji="â™»ï¸" ;;
  test)     emoji="âœ…" ;;
  docs)     emoji="ðŸ“" ;;
  style)    emoji="ðŸ’„" ;;
  chore)    emoji="ðŸ”§" ;;
  ci)       emoji="ðŸ”" ;;
  build)    emoji="ðŸ“¦" ;;
  revert)   emoji="âª" ;;
esac

if [ -z "$emoji" ] || [ -z "$normalized_type" ]; then
  echo "â›” ì»¤ë°‹ ë©”ì‹œì§€ íƒ€ìž…ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."
  echo "   https://github.com/team3/tasteam/tree/main/docs/convention/ì»¤ë°‹%20ë¸Œëžœì¹˜%20ì „ëžµ/ë¸Œëžœì¹˜_ì»¤ë°‹_ì „ëžµ.md ë¥¼ ì°¸ê³ í•˜ì„¸ìš”."
  echo "   ì‚¬ìš© ê°€ëŠ¥í•œ íƒ€ìž…: feat, fix, perf, refactor, test, docs, style, chore, ci, build, revert"
  exit 1
fi

formatted_first_line=$(echo "$first_line" | sed "s/^$type/$emoji $normalized_type/")

{
  echo "$formatted_first_line"
  echo "$remaining_lines"
} > "$COMMIT_MESSAGE_FILE"
